<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">

 <!-- to setup camel servlet with OSGi HttpService -->
  <reference id="httpService" interface="org.osgi.service.http.HttpService"/>

  <bean class="org.apache.camel.component.servlet.osgi.OsgiServletRegisterer" destroy-method="unregister" init-method="register">
    <property name="alias" value="/scan"/>
    <property name="httpService" ref="httpService"/>
    <property name="servlet" ref="camelServlet"/>
  </bean>
  
  <bean class="org.apache.camel.component.servlet.CamelHttpTransportServlet" id="camelServlet"/>
  
 
    <camelContext xmlns="http://camel.apache.org/schema/blueprint">
		<restConfiguration bindingMode="off" component="servlet" contextPath="/scan" enableCORS="true"/>	  

		<rest path="/ping">
			<get uri="/" >
				<to uri="direct:ping" />
			</get>
		</rest>

		<rest path="/batch">
			<get uri="/start" produces="application/json">
				<to uri="direct:start" />
			</get>
			<get uri="/nextpage" produces="application/json">
				<to uri="direct:nextpage" />
			</get>
			<get uri="/stop" produces="application/json">
				<to uri="direct:stop" />
			</get>
			<post uri="/">
				<to uri="direct:uploaddoc" />
			</post>
			<delete uri="/">
				<to uri="direct:cancel" />
			</delete>
		</rest>

	  <route>
		<from uri="direct:ping" />
		<transform>
			<constant>Hello, I'm ready to scan</constant>
		</transform>
	  </route>
	  
	  <route>
		<from uri="direct:start" />
		<to uri="exec:///home/pi/scanstation/scripts/startscan.sh" />
	  </route>
	  
	  <route>
		<from uri="direct:nextpage" />
		<to uri="exec:///home/pi/scanstation/scripts/nextpage.sh" />
	  </route>

	  <route>
		<from uri="direct:stop" />
		<to uri="exec:///home/pi/scanstation/scripts/stopscan.sh" />
	  </route>

	  <route>
		<from uri="direct:uploaddoc" />
		<to uri="cmis:///home/pi" />
	  </route>
	  
	  <route>
		<from uri="direct:cancel" />
		<to uri="exec:///home/pi/scanstation/scripts/cancelscan.sh" />
		<setHeader headerName="Exchange.HTTP_RESPONSE_CODE"><constant>204</constant></setHeader>
	  </route>

    </camelContext>

</blueprint>
